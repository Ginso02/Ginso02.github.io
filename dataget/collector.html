<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ•™è‚²æ•°æ®é‡‡é›†é¡µé¢</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
:root {
    --primary: #4361ee;
    --primary-light: #4895ef;
    --secondary: #3f37c9;
    --accent: #4cc9f0;
    --success: #4ade80;
    --warning: #f59e0b;
    --danger: #ef4444;
    --dark: #1e293b;
    --light: #f8fafc;
    --gray: #64748b;
    --gray-light: #e2e8f0;
    --border-radius: 12px;
    --shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1);
    --transition: all 0.3s ease;
}

* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

body {
    font-family: 'Inter', sans-serif;
    background: linear-gradient(135deg, #f0f4ff 0%, #e6f0ff 100%);
    min-height: 100vh;
    color: var(--dark);
    line-height: 1.6;
}

.container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 30px;
}

.header {
    text-align: center;
    margin-bottom: 40px;
    position: relative;
}

.header h1 {
    font-size: 2.5rem;
    font-weight: 700;
    background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    margin-bottom: 15px;
    letter-spacing: -0.5px;
}

.header p {
    font-size: 1.1rem;
    color: var(--gray);
    max-width: 600px;
    margin: 0 auto;
}

.controls {
    text-align: center;
    margin-bottom: 30px;
    padding: 20px;
    background: white;
    border-radius: var(--border-radius);
    box-shadow: var(--shadow);
}

.controls button {
    background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
    color: white;
    border: none;
    padding: 12px 24px;
    border-radius: 8px;
    cursor: pointer;
    font-size: 1rem;
    font-weight: 500;
    transition: var(--transition);
    margin: 5px;
    display: inline-flex;
    align-items: center;
    gap: 8px;
    box-shadow: 0 4px 12px rgba(67, 97, 238, 0.2);
}

.controls button:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 18px rgba(67, 97, 238, 0.3);
}

.controls button.secondary {
    background: white;
    color: var(--primary);
    border: 1px solid var(--primary-light);
}

.status-bar {
    background: white;
    border-radius: var(--border-radius);
    padding: 20px;
    margin-bottom: 30px;
    box-shadow: var(--shadow);
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-wrap: wrap;
    gap: 15px;
}

.status-item {
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 10px;
    border-radius: 8px;
    background: var(--light);
    min-width: 120px;
}

.status-value {
    font-size: 1.5rem;
    font-weight: 700;
    color: var(--primary);
    margin-bottom: 5px;
}

.status-label {
    font-size: 0.9rem;
    color: var(--gray);
}

.data-popup {
    position: fixed;
    top: 20px;
    right: 20px;
    width: 300px;
    background: white;
    border-radius: var(--border-radius);
    box-shadow: var(--shadow);
    padding: 20px;
    display: none;
    z-index: 1000;
    border-left: 4px solid var(--primary);
}

.popup-header {
    display: flex;
    justify-content: between;
    align-items: center;
    margin-bottom: 15px;
}

.popup-title {
    font-weight: 600;
    color: var(--dark);
    flex: 1;
}

.popup-close {
    background: none;
    border: none;
    font-size: 1.2rem;
    cursor: pointer;
    color: var(--gray);
    padding: 0;
    width: 24px;
    height: 24px;
    display: flex;
    align-items: center;
    justify-content: center;
}

.popup-content {
    font-family: 'SF Mono', 'Monaco', 'Consolas', monospace;
    font-size: 0.85rem;
    background: var(--light);
    padding: 12px;
    border-radius: 8px;
    max-height: 200px;
    overflow-y: auto;
    white-space: pre-wrap;
}

.activity-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 25px;
    margin-bottom: 30px;
}

.activity-card {
    background: white;
    border-radius: var(--border-radius);
    padding: 25px;
    box-shadow: var(--shadow);
    transition: var(--transition);
    position: relative;
    overflow: hidden;
    border: 1px solid rgba(255, 255, 255, 0.2);
}

.activity-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 4px;
    background: linear-gradient(90deg, var(--primary), var(--accent));
}

.activity-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 15px 30px -10px rgba(0, 0, 0, 0.15);
}

.activity-card h3 {
    color: var(--dark);
    margin-bottom: 15px;
    font-size: 1.3rem;
    font-weight: 600;
    display: flex;
    align-items: center;
    gap: 10px;
}

.activity-card h3 .icon {
    width: 32px;
    height: 32px;
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: rgba(67, 97, 238, 0.1);
    color: var(--primary);
    font-size: 1.2rem;
}

.quiz-container {
    margin: 15px 0;
}

.question {
    margin-bottom: 15px;
    padding: 15px;
    background: rgba(67, 97, 238, 0.05);
    border-radius: 8px;
    border-left: 4px solid var(--primary);
}

.options label {
    display: flex;
    align-items: center;
    margin: 8px 0;
    cursor: pointer;
    padding: 10px;
    border-radius: 6px;
    transition: var(--transition);
    border: 1px solid transparent;
}

.options label:hover {
    background-color: rgba(67, 97, 238, 0.08);
    border-color: rgba(67, 97, 238, 0.2);
}

.options input {
    margin-right: 10px;
    transform: scale(1.1);
}

.typing-area {
    width: 100%;
    min-height: 120px;
    border: 2px solid var(--gray-light);
    border-radius: 8px;
    padding: 15px;
    font-family: 'Inter', sans-serif;
    font-size: 1rem;
    resize: vertical;
    transition: var(--transition);
    background: white;
}

.typing-area:focus {
    outline: none;
    border-color: var(--primary);
    box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.1);
}

.heatmap-grid {
    display: grid;
    grid-template-columns: repeat(12, 1fr);
    gap: 3px;
    margin: 15px 0;
    padding: 15px;
    background: var(--light);
    border-radius: 8px;
}

.heatmap-cell {
    aspect-ratio: 1;
    background: var(--gray-light);
    border-radius: 3px;
    transition: all 0.3s ease;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.7rem;
    font-weight: 600;
}

.heatmap-cell:hover {
    transform: scale(1.1);
}

.timer-display {
    font-size: 1.1rem;
    font-weight: 600;
    color: var(--primary);
    text-align: center;
    margin: 10px 0;
    padding: 8px;
    background: rgba(67, 97, 238, 0.05);
    border-radius: 6px;
}

.progress-bar {
    width: 100%;
    height: 8px;
    background: var(--gray-light);
    border-radius: 4px;
    overflow: hidden;
    margin: 12px 0;
}

.progress-fill {
    height: 100%;
    background: linear-gradient(90deg, var(--success), #22c55e);
    transition: width 0.5s ease;
    border-radius: 4px;
}

@media (max-width: 768px) {
    .container {
        padding: 20px;
    }
    
    .header h1 {
        font-size: 2rem;
    }
    
    .activity-grid {
        grid-template-columns: 1fr;
        gap: 20px;
    }
    
    .status-bar {
        flex-direction: column;
        gap: 10px;
    }
    
    .data-popup {
        width: calc(100vw - 40px);
        right: 20px;
        top: 10px;
    }
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(20px); }
    to { opacity: 1; transform: translateY(0); }
}

.activity-card {
    animation: fadeIn 0.6s ease-out;
}

::-webkit-scrollbar {
    width: 6px;
}

::-webkit-scrollbar-track {
    background: #f1f1f1;
    border-radius: 10px;
}

::-webkit-scrollbar-thumb {
    background: var(--primary-light);
    border-radius: 10px;
}

::-webkit-scrollbar-thumb:hover {
    background: var(--primary);
}
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>æ•™è‚²æ•°æ®é‡‡é›†é¡µé¢</h1>
            <p>åœ¨æ­¤é¡µé¢è¿›è¡Œå„ç§å­¦ä¹ æ´»åŠ¨ï¼Œæ•°æ®å°†å®æ—¶ä¼ è¾“åˆ°æ˜¾ç¤ºé¡µé¢</p>
        </div>

        <div class="controls">
            <button onclick="openDisplayWindow()">
                <span>ğŸ“Š</span> æ‰“å¼€æ•°æ®æ˜¾ç¤ºé¡µé¢
            </button>
            <button onclick="startDataCollection()" id="startBtn">
                <span>â–¶ï¸</span> å¼€å§‹æ•°æ®é‡‡é›†
            </button>
            <button onclick="pauseDataCollection()" class="secondary" id="pauseBtn" disabled>
                <span>â¸ï¸</span> æš‚åœé‡‡é›†
            </button>
            <button onclick="resetData()" class="secondary">
                <span>ğŸ”„</span> é‡ç½®æ•°æ®
            </button>
        </div>

        <div class="status-bar">
            <div class="status-item">
                <div class="status-value" id="sessionTime">00:00</div>
                <div class="status-label">é‡‡é›†æ—¶é—´</div>
            </div>
            <div class="status-item">
                <div class="status-value" id="totalEvents">0</div>
                <div class="status-label">æ€»äº‹ä»¶æ•°</div>
            </div>
            <div class="status-item">
                <div class="status-value" id="activeUsers">1</div>
                <div class="status-label">æ´»è·ƒç”¨æˆ·</div>
            </div>
            <div class="status-item">
                <div class="status-value" id="dataSize">0KB</div>
                <div class="status-label">æ•°æ®å¤§å°</div>
            </div>
        </div>

        <!-- æ•°æ®å¼¹çª— -->
        <div class="data-popup" id="dataPopup">
            <div class="popup-header">
                <div class="popup-title">å®æ—¶æ•°æ®</div>
                <button class="popup-close" onclick="hideDataPopup()">Ã—</button>
            </div>
            <div class="popup-content" id="popupContent">
                ç­‰å¾…æ•°æ®é‡‡é›†...
            </div>
        </div>

        <div class="activity-grid">
            <!-- æµ‹éªŒç­”é¢˜åŒºåŸŸ -->
            <div class="activity-card">
                <h3><span class="icon">ğŸ“</span>çŸ¥è¯†æµ‹éªŒ</h3>
                <div class="quiz-container">
                    <div class="timer-display" id="quizTimer">00:00</div>
                    <div class="question">
                        <p><strong>1. JavaScriptæ˜¯ä»€ä¹ˆç±»å‹çš„è¯­è¨€ï¼Ÿ</strong></p>
                        <div class="options">
                            <label><input type="radio" name="q1" value="A" data-question="1"> A. ç¼–è¯‘å‹è¯­è¨€</label>
                            <label><input type="radio" name="q1" value="B" data-question="1"> B. è§£é‡Šå‹è¯­è¨€</label>
                            <label><input type="radio" name="q1" value="C" data-question="1"> C. æ±‡ç¼–è¯­è¨€</label>
                            <label><input type="radio" name="q1" value="D" data-question="1"> D. æœºå™¨è¯­è¨€</label>
                        </div>
                    </div>
                    <div class="question">
                        <p><strong>2. ä»¥ä¸‹å“ªä¸ªæ˜¯CSSé¢„å¤„ç†å™¨ï¼Ÿ</strong></p>
                        <div class="options">
                            <label><input type="radio" name="q2" value="A" data-question="2"> A. HTML</label>
                            <label><input type="radio" name="q2" value="B" data-question="2"> B. SASS</label>
                            <label><input type="radio" name="q2" value="C" data-question="2"> C. PHP</label>
                            <label><input type="radio" name="q2" value="D" data-question="2"> D. MySQL</label>
                        </div>
                    </div>
                    <button onclick="submitQuiz()">æäº¤æµ‹éªŒ</button>
                </div>
            </div>

            <!-- æ–‡æœ¬è¾“å…¥åˆ†æ -->
            <div class="activity-card">
                <h3><span class="icon">âŒ¨ï¸</span>å†™ä½œç»ƒä¹ </h3>
                <p>åœ¨ä¸‹æ–¹æ–‡æœ¬æ¡†ä¸­è¿›è¡Œå†™ä½œï¼Œç³»ç»Ÿå°†åˆ†ææ‚¨çš„è¾“å…¥æ¨¡å¼</p>
                <textarea class="typing-area" id="essayInput" placeholder="è¯·å†™ä¸€ç¯‡å…³äºå‰ç«¯å¼€å‘çš„çŸ­æ–‡..."></textarea>
                <div class="progress-bar">
                    <div class="progress-fill" id="writingProgress" style="width: 0%"></div>
                </div>
                <p>ç›®æ ‡å­—æ•°: 200å­—</p>
            </div>

            <!-- äº¤äº’çƒ­åŠ›å›¾ -->
            <div class="activity-card">
                <h3><span class="icon">ğŸ¯</span>äº¤äº’ç»ƒä¹ </h3>
                <p>ç‚¹å‡»ä¸‹æ–¹ç½‘æ ¼åŒºåŸŸï¼Œè§‚å¯Ÿæ‚¨çš„äº¤äº’æ¨¡å¼</p>
                <div class="heatmap-grid" id="interactionGrid">
                    <!-- å°†ç”±JavaScriptåŠ¨æ€ç”Ÿæˆ -->
                </div>
                <button onclick="clearHeatmap()">æ¸…é™¤çƒ­åŠ›å›¾</button>
            </div>

            <!-- ä¸“æ³¨åº¦è®­ç»ƒ -->
            <div class="activity-card">
                <h3><span class="icon">ğŸ§˜</span>ä¸“æ³¨åº¦è®­ç»ƒ</h3>
                <p>ä¿æŒåœ¨æ­¤é¡µé¢ï¼Œé¿å…åˆ‡æ¢æ ‡ç­¾é¡µæˆ–çª—å£</p>
                <div class="timer-display" id="focusTimer">ä¸“æ³¨æ—¶é—´: 00:00</div>
                <div class="progress-bar">
                    <div class="progress-fill" id="focusProgress" style="width: 0%"></div>
                </div>
                <div style="text-align: center; margin-top: 15px;">
                    <div id="focusStatus" style="font-weight: 600;">å‡†å¤‡å¼€å§‹</div>
                </div>
                <button onclick="startFocusTraining()">å¼€å§‹ä¸“æ³¨è®­ç»ƒ</button>
            </div>

            <!-- é˜…è¯»ç†è§£ -->
            <div class="activity-card">
                <h3><span class="icon">ğŸ“–</span>é˜…è¯»ç†è§£</h3>
                <div style="background: var(--light); padding: 15px; border-radius: 8px; margin-bottom: 15px; line-height: 1.8;">
                    <h4>å‰ç«¯å¼€å‘æŠ€æœ¯æ ˆ</h4>
                    <p>ç°ä»£å‰ç«¯å¼€å‘é€šå¸¸åŒ…æ‹¬HTMLã€CSSå’ŒJavaScriptä¸‰å¤§æ ¸å¿ƒæŠ€æœ¯ã€‚HTMLè´Ÿè´£ç½‘é¡µçš„ç»“æ„å’Œå†…å®¹ï¼ŒCSSç”¨äºæ ·å¼å’Œå¸ƒå±€è®¾è®¡ï¼Œè€ŒJavaScriptåˆ™æä¾›äº¤äº’åŠŸèƒ½å’ŒåŠ¨æ€æ•ˆæœã€‚</p>
                    <p>éšç€æŠ€æœ¯çš„å‘å±•ï¼Œç°åœ¨è¿˜æœ‰å¾ˆå¤šæ¡†æ¶å’Œå·¥å…·å¸®åŠ©å¼€å‘è€…æé«˜æ•ˆç‡ï¼Œæ¯”å¦‚Reactã€Vue.jsã€Angularç­‰å‰ç«¯æ¡†æ¶ï¼Œä»¥åŠWebpackã€Viteç­‰æ„å»ºå·¥å…·ã€‚</p>
                </div>
                <div class="question">
                    <p><strong>æ ¹æ®ä¸Šæ–‡ï¼Œå‰ç«¯å¼€å‘çš„ä¸‰å¤§æ ¸å¿ƒæŠ€æœ¯æ˜¯ä»€ä¹ˆï¼Ÿ</strong></p>
                    <div class="options">
                        <label><input type="radio" name="reading" value="A"> A. HTMLã€CSSã€JavaScript</label>
                        <label><input type="radio" name="reading" value="B"> B. Reactã€Vueã€Angular</label>
                        <label><input type="radio" name="reading" value="C"> C. HTMLã€PHPã€MySQL</label>
                        <label><input type="radio" name="reading" value="D"> D. CSSã€Webpackã€Vite</label>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
// å…¨å±€æ•°æ®å­˜å‚¨
let dataCollection = {
    sessionId: 'session_' + Date.now(),
    startTime: null,
    isCollecting: false,
    events: [],
    quizData: [],
    writingData: [],
    interactionData: [],
    focusData: [],
    readingData: []
};

let displayWindow = null;
let sessionTimer = null;
let focusTimer = null;

// é¡µé¢åŠ è½½åˆå§‹åŒ–
window.onload = function() {
    initializeCollector();
    setupEventListeners();
};

// åˆå§‹åŒ–æ•°æ®é‡‡é›†å™¨
function initializeCollector() {
    console.log('æ•°æ®é‡‡é›†å™¨åˆå§‹åŒ–å®Œæˆ');
    updateStatusDisplay();
}

// è®¾ç½®äº‹ä»¶ç›‘å¬å™¨
function setupEventListeners() {
    // é¡µé¢äº¤äº’äº‹ä»¶
    document.addEventListener('click', recordClickEvent);
    document.addEventListener('scroll', recordScrollEvent);
    document.addEventListener('mousemove', recordMouseEvent);
    document.addEventListener('keypress', recordKeyEvent);
    
    // é¡µé¢ç„¦ç‚¹äº‹ä»¶
    window.addEventListener('focus', recordFocusEvent);
    window.addEventListener('blur', recordBlurEvent);
    
    // æµ‹éªŒé€‰æ‹©äº‹ä»¶
    document.querySelectorAll('input[type="radio"]').forEach(radio => {
        radio.addEventListener('change', recordQuizSelection);
    });
    
    // å†™ä½œè¾“å…¥äº‹ä»¶
    const essayInput = document.getElementById('essayInput');
    essayInput.addEventListener('input', recordWritingEvent);
    essayInput.addEventListener('paste', recordPasteEvent);
    
    // ç”Ÿæˆäº¤äº’ç½‘æ ¼
    generateInteractionGrid();
    
    // é˜…è¯»é€‰æ‹©äº‹ä»¶
    document.querySelectorAll('input[name="reading"]').forEach(radio => {
        radio.addEventListener('change', recordReadingAnswer);
    });
}

// å¼€å§‹æ•°æ®é‡‡é›†
function startDataCollection() {
    dataCollection.isCollecting = true;
    dataCollection.startTime = Date.now();
    
    document.getElementById('startBtn').disabled = true;
    document.getElementById('pauseBtn').disabled = false;
    
    // å¼€å§‹è®¡æ—¶å™¨
    sessionTimer = setInterval(updateSessionTimer, 1000);
    
    // è®°å½•å¼€å§‹äº‹ä»¶
    recordEvent('session_start', { timestamp: dataCollection.startTime });
    
    console.log('æ•°æ®é‡‡é›†å·²å¼€å§‹');
}

// æš‚åœæ•°æ®é‡‡é›†
function pauseDataCollection() {
    dataCollection.isCollecting = false;
    
    document.getElementById('startBtn').disabled = false;
    document.getElementById('pauseBtn').disabled = true;
    
    if (sessionTimer) {
        clearInterval(sessionTimer);
        sessionTimer = null;
    }
    
    recordEvent('session_pause', { timestamp: Date.now() });
    console.log('æ•°æ®é‡‡é›†å·²æš‚åœ');
}

// é‡ç½®æ•°æ®
function resetData() {
    dataCollection = {
        sessionId: 'session_' + Date.now(),
        startTime: null,
        isCollecting: false,
        events: [],
        quizData: [],
        writingData: [],
        interactionData: [],
        focusData: [],
        readingData: []
    };
    
    // é‡ç½®æ˜¾ç¤º
    updateStatusDisplay();
    clearHeatmap();
    document.getElementById('essayInput').value = '';
    document.getElementById('writingProgress').style.width = '0%';
    document.getElementById('focusProgress').style.width = '0%';
    
    // é‡ç½®é€‰æ‹©
    document.querySelectorAll('input[type="radio"]').forEach(radio => {
        radio.checked = false;
    });
    
    console.log('æ•°æ®å·²é‡ç½®');
}

// è®°å½•é€šç”¨äº‹ä»¶
function recordEvent(type, data) {
    if (!dataCollection.isCollecting && type !== 'session_start') return;
    
    const event = {
        type: type,
        timestamp: Date.now(),
        sessionId: dataCollection.sessionId,
        ...data
    };
    
    dataCollection.events.push(event);
    updateStatusDisplay();
    sendDataToDisplay();
    
    // æ˜¾ç¤ºåœ¨å¼¹çª—ä¸­
    showRecentEvent(event);
}

// è®°å½•ç‚¹å‡»äº‹ä»¶
function recordClickEvent(e) {
    recordEvent('click', {
        element: e.target.tagName,
        className: e.target.className,
        x: e.clientX,
        y: e.clientY,
        pageX: e.pageX,
        pageY: e.pageY
    });
}

// è®°å½•æ»šåŠ¨äº‹ä»¶
let scrollThrottle = false;
function recordScrollEvent() {
    if (scrollThrottle) return;
    scrollThrottle = true;
    
    setTimeout(() => {
        recordEvent('scroll', {
            scrollY: window.scrollY,
            scrollX: window.scrollX,
            documentHeight: document.body.scrollHeight,
            viewportHeight: window.innerHeight
        });
        scrollThrottle = false;
    }, 100);
}

// è®°å½•é¼ æ ‡ç§»åŠ¨ï¼ˆèŠ‚æµï¼‰
let mouseThrottle = false;
function recordMouseEvent(e) {
    if (mouseThrottle) return;
    mouseThrottle = true;
    
    setTimeout(() => {
        recordEvent('mousemove', {
            x: e.clientX,
            y: e.clientY
        });
        mouseThrottle = false;
    }, 200);
}

// è®°å½•æŒ‰é”®äº‹ä»¶
function recordKeyEvent(e) {
    recordEvent('keypress', {
        key: e.key,
        keyCode: e.keyCode,
        target: e.target.tagName
    });
}

// è®°å½•ç„¦ç‚¹äº‹ä»¶
function recordFocusEvent() {
    recordEvent('focus', { type: 'page_focus' });
}

function recordBlurEvent() {
    recordEvent('blur', { type: 'page_blur' });
}

// è®°å½•æµ‹éªŒé€‰æ‹©
function recordQuizSelection(e) {
    const quizData = {
        question: e.target.dataset.question,
        answer: e.target.value,
        timestamp: Date.now(),
        timeFromStart: dataCollection.startTime ? Date.now() - dataCollection.startTime : 0
    };
    
    dataCollection.quizData.push(quizData);
    recordEvent('quiz_selection', quizData);
}

// æäº¤æµ‹éªŒ
function submitQuiz() {
    const answers = dataCollection.quizData.filter(q => q.question);
    recordEvent('quiz_submit', {
        totalQuestions: 2,
        answeredQuestions: answers.length,
        answers: answers,
        completionTime: Date.now() - dataCollection.startTime
    });
    
    alert(`æµ‹éªŒæäº¤æˆåŠŸï¼æ‚¨å›ç­”äº† ${answers.length}/2 é“é¢˜ç›®ã€‚`);
}

// è®°å½•å†™ä½œäº‹ä»¶
let writingTimer = null;
function recordWritingEvent(e) {
    const text = e.target.value;
    const wordCount = text.length;
    const progress = Math.min(100, (wordCount / 200) * 100);
    
    document.getElementById('writingProgress').style.width = progress + '%';
    
    // æ¸…é™¤ä¹‹å‰çš„è®¡æ—¶å™¨
    if (writingTimer) clearTimeout(writingTimer);
    
    // è®¾ç½®æ–°çš„è®¡æ—¶å™¨ï¼Œ500msåè®°å½•
    writingTimer = setTimeout(() => {
        const writingData = {
            wordCount: wordCount,
            progress: progress,
            timestamp: Date.now()
        };
        
        dataCollection.writingData.push(writingData);
        recordEvent('writing_progress', writingData);
    }, 500);
}

// è®°å½•ç²˜è´´äº‹ä»¶
function recordPasteEvent(e) {
    recordEvent('paste_event', {
        target: 'essay_input',
        timestamp: Date.now()
    });
}

// ç”Ÿæˆäº¤äº’ç½‘æ ¼
function generateInteractionGrid() {
    const grid = document.getElementById('interactionGrid');
    grid.innerHTML = '';
    
    for (let i = 0; i < 48; i++) {
        const cell = document.createElement('div');
        cell.className = 'heatmap-cell';
        cell.dataset.index = i;
        cell.addEventListener('click', handleGridClick);
        grid.appendChild(cell);
    }
}

// å¤„ç†ç½‘æ ¼ç‚¹å‡»
function handleGridClick(e) {
    const index = parseInt(e.target.dataset.index);
    
    // æŸ¥æ‰¾ç°æœ‰æ•°æ®
    let cellData = dataCollection.interactionData.find(d => d.cellIndex === index);
    
    if (cellData) {
        cellData.clicks++;
    } else {
        cellData = {
            cellIndex: index,
            clicks: 1,
            firstClick: Date.now()
        };
        dataCollection.interactionData.push(cellData);
    }
    
    // æ›´æ–°è§†è§‰æ•ˆæœ
    const intensity = Math.min(1, cellData.clicks / 5);
    e.target.style.backgroundColor = `rgba(67, 97, 238, ${intensity})`;
    e.target.style.color = intensity > 0.5 ? 'white' : 'black';
    e.target.textContent = cellData.clicks;
    
    recordEvent('grid_click', {
        cellIndex: index,
        clicks: cellData.clicks,
        timestamp: Date.now()
    });
}

// æ¸…é™¤çƒ­åŠ›å›¾
function clearHeatmap() {
    dataCollection.interactionData = [];
    document.querySelectorAll('.heatmap-cell').forEach(cell => {
        cell.style.backgroundColor = '';
        cell.style.color = '';
        cell.textContent = '';
    });
    recordEvent('heatmap_clear', { timestamp: Date.now() });
}

// å¼€å§‹ä¸“æ³¨è®­ç»ƒ
function startFocusTraining() {
    if (focusTimer) clearInterval(focusTimer);
    
    let focusStartTime = Date.now();
    let focusScore = 0;
    
    document.getElementById('focusStatus').textContent = 'ä¸“æ³¨è®­ç»ƒè¿›è¡Œä¸­...';
    
    focusTimer = setInterval(() => {
        const elapsed = Date.now() - focusStartTime;
        const minutes = Math.floor(elapsed / 60000);
        const seconds = Math.floor((elapsed % 60000) / 1000);
        
        document.getElementById('focusTimer').textContent = 
            `ä¸“æ³¨æ—¶é—´: ${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        
        // å‡è®¾3åˆ†é’Ÿä¸ºæ»¡åˆ†
        const progress = Math.min(100, (elapsed / 180000) * 100);
        document.getElementById('focusProgress').style.width = progress + '%';
        
        // è®°å½•ä¸“æ³¨æ•°æ®
        const focusData = {
            elapsedTime: elapsed,
            progress: progress,
            timestamp: Date.now()
        };
        
        dataCollection.focusData.push(focusData);
        
        if (elapsed >= 180000) { // 3åˆ†é’Ÿå®Œæˆ
            clearInterval(focusTimer);
            document.getElementById('focusStatus').textContent = 'ä¸“æ³¨è®­ç»ƒå®Œæˆï¼';
            recordEvent('focus_training_complete', focusData);
        }
    }, 1000);
    
    recordEvent('focus_training_start', { timestamp: focusStartTime });
}

// è®°å½•é˜…è¯»ç­”æ¡ˆ
function recordReadingAnswer(e) {
    const readingData = {
        answer: e.target.value,
        timestamp: Date.now(),
        timeFromStart: dataCollection.startTime ? Date.now() - dataCollection.startTime : 0
    };
    
    dataCollection.readingData.push(readingData);
    recordEvent('reading_answer', readingData);
}

// æ›´æ–°çŠ¶æ€æ˜¾ç¤º
function updateStatusDisplay() {
    // ä¼šè¯æ—¶é—´
    if (dataCollection.startTime) {
        const elapsed = Date.now() - dataCollection.startTime;
        const minutes = Math.floor(elapsed / 60000);
        const seconds = Math.floor((elapsed % 60000) / 1000);
        document.getElementById('sessionTime').textContent = 
            `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
    }
    
    // æ€»äº‹ä»¶æ•°
    document.getElementById('totalEvents').textContent = dataCollection.events.length;
    
    // æ•°æ®å¤§å°ä¼°ç®—
    const dataSize = JSON.stringify(dataCollection).length;
    document.getElementById('dataSize').textContent = 
        dataSize > 1024 ? `${(dataSize / 1024).toFixed(1)}KB` : `${dataSize}B`;
}

// æ›´æ–°ä¼šè¯è®¡æ—¶å™¨
function updateSessionTimer() {
    updateStatusDisplay();
}

// æ˜¾ç¤ºæœ€è¿‘äº‹ä»¶
function showRecentEvent(event) {
    const popup = document.getElementById('dataPopup');
    const content = document.getElementById('popupContent');
    
    const eventStr = `${new Date(event.timestamp).toLocaleTimeString()}: ${event.type}\n${JSON.stringify(event, null, 2)}`;
    content.textContent = eventStr;
    
    popup.style.display = 'block';
    
    // 3ç§’åè‡ªåŠ¨éšè—
    setTimeout(() => {
        popup.style.display = 'none';
    }, 3000);
}

// éšè—æ•°æ®å¼¹çª—
function hideDataPopup() {
    document.getElementById('dataPopup').style.display = 'none';
}

// æ‰“å¼€æ•°æ®æ˜¾ç¤ºçª—å£
function openDisplayWindow() {
    if (displayWindow && !displayWindow.closed) {
        displayWindow.focus();
        return;
    }
    
    displayWindow = window.open(
        './dashboard.html',
        'dataDisplay',
        'width=1200,height=800,scrollbars=yes,resizable=yes'
    );
    
    // ç­‰å¾…çª—å£åŠ è½½å®Œæˆåå‘é€åˆå§‹æ•°æ®
    setTimeout(() => {
        sendDataToDisplay();
    }, 1000);
}

// å‘é€æ•°æ®åˆ°æ˜¾ç¤ºé¡µé¢
function sendDataToDisplay() {
    if (displayWindow && !displayWindow.closed) {
        try {
            displayWindow.postMessage({
                type: 'dataUpdate',
                data: dataCollection
            }, '*');
        } catch (error) {
            console.warn('å‘é€æ•°æ®åˆ°æ˜¾ç¤ºçª—å£å¤±è´¥:', error);
        }
    }
    
    // åŒæ—¶å­˜å‚¨åˆ°localStorage
    localStorage.setItem('educationData', JSON.stringify(dataCollection));
}

// ç›‘å¬æ˜¾ç¤ºçª—å£çš„è¯·æ±‚
window.addEventListener('message', function(event) {
    if (event.data.type === 'requestData') {
        sendDataToDisplay();
    }
});

// é¡µé¢å¸è½½æ—¶æ¸…ç†
window.addEventListener('beforeunload', function() {
    if (displayWindow && !displayWindow.closed) {
        displayWindow.postMessage({
            type: 'collectorClosed',
            data: {}
        }, '*');
    }
});
    </script>
</body>
</html>