<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ•°æ®æ˜¾ç¤ºæ§åˆ¶å°</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
:root {
    --primary: #4361ee;
    --primary-light: #4895ef;
    --secondary: #3f37c9;
    --accent: #4cc9f0;
    --success: #4ade80;
    --warning: #f59e0b;
    --danger: #ef4444;
    --dark: #1e293b;
    --light: #f8fafc;
    --gray: #64748b;
    --gray-light: #e2e8f0;
    --border-radius: 12px;
    --shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1);
    --transition: all 0.3s ease;
}

* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

body {
    font-family: 'Inter', sans-serif;
    background: linear-gradient(135deg, #1a1c29 0%, #16213e 100%);
    min-height: 100vh;
    color: white;
    line-height: 1.6;
    overflow-x: hidden;
}

.dashboard {
    display: grid;
    grid-template-areas: 
        "header header"
        "sidebar main";
    grid-template-columns: 280px 1fr;
    grid-template-rows: auto 1fr;
    min-height: 100vh;
}

.header {
    grid-area: header;
    background: rgba(255, 255, 255, 0.1);
    backdrop-filter: blur(10px);
    padding: 20px 30px;
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.header h1 {
    font-size: 1.8rem;
    font-weight: 700;
    background: linear-gradient(135deg, #4cc9f0 0%, #4361ee 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
}

.connection-status {
    display: flex;
    align-items: center;
    gap: 10px;
    font-size: 0.9rem;
}

.status-dot {
    width: 12px;
    height: 12px;
    border-radius: 50%;
    background: var(--danger);
    animation: pulse 2s infinite;
}

.status-dot.connected {
    background: var(--success);
}

.sidebar {
    grid-area: sidebar;
    background: rgba(255, 255, 255, 0.05);
    padding: 20px;
    border-right: 1px solid rgba(255, 255, 255, 0.1);
    overflow-y: auto;
}

.stats-grid {
    display: grid;
    gap: 15px;
    margin-bottom: 25px;
}

.stat-card {
    background: rgba(255, 255, 255, 0.1);
    border-radius: 10px;
    padding: 15px;
    text-align: center;
    backdrop-filter: blur(5px);
    border: 1px solid rgba(255, 255, 255, 0.1);
}

.stat-value {
    font-size: 1.8rem;
    font-weight: 700;
    color: var(--accent);
    margin-bottom: 5px;
}

.stat-label {
    font-size: 0.85rem;
    opacity: 0.8;
}

.main-content {
    grid-area: main;
    padding: 30px;
    overflow-y: auto;
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
    gap: 25px;
    align-content: start;
}

.data-panel {
    background: rgba(255, 255, 255, 0.1);
    border-radius: var(--border-radius);
    padding: 20px;
    backdrop-filter: blur(10px);
    border: 1px solid rgba(255, 255, 255, 0.1);
    height: fit-content;
}

.panel-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 15px;
    padding-bottom: 10px;
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
}

.panel-title {
    font-size: 1.1rem;
    font-weight: 600;
    display: flex;
    align-items: center;
    gap: 8px;
}

.panel-badge {
    background: var(--primary);
    color: white;
    padding: 2px 8px;
    border-radius: 12px;
    font-size: 0.7rem;
    font-weight: 600;
}

.data-display {
    background: rgba(0, 0, 0, 0.3);
    border-radius: 8px;
    padding: 15px;
    font-family: 'SF Mono', 'Monaco', 'Consolas', monospace;
    font-size: 0.85rem;
    line-height: 1.5;
    max-height: 300px;
    overflow-y: auto;
    border: 1px solid rgba(255, 255, 255, 0.1);
    white-space: pre-wrap;
    word-wrap: break-word;
}

.event-stream {
    max-height: 400px;
    overflow-y: auto;
}

.event-item {
    display: flex;
    align-items: flex-start;
    gap: 10px;
    padding: 8px 0;
    border-bottom: 1px solid rgba(255, 255, 255, 0.05);
}

.event-time {
    color: var(--accent);
    font-size: 0.75rem;
    min-width: 60px;
    font-family: monospace;
}

.event-type {
    background: rgba(67, 97, 238, 0.3);
    color: var(--accent);
    padding: 2px 6px;
    border-radius: 4px;
    font-size: 0.7rem;
    min-width: 80px;
    text-align: center;
}

.event-data {
    flex: 1;
    font-size: 0.8rem;
    opacity: 0.9;
}

.chart-container {
    margin: 15px 0;
    height: 200px;
    background: rgba(0, 0, 0, 0.2);
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--gray);
    position: relative;
    overflow: hidden;
}

.activity-chart {
    width: 100%;
    height: 100%;
    display: flex;
    align-items: end;
    padding: 20px;
    gap: 2px;
}

.activity-bar {
    background: linear-gradient(to top, var(--primary), var(--accent));
    border-radius: 2px 2px 0 0;
    min-height: 5px;
    flex: 1;
    opacity: 0.7;
    transition: opacity 0.3s;
}

.activity-bar:hover {
    opacity: 1;
}

.heatmap-visual {
    display: grid;
    grid-template-columns: repeat(12, 1fr);
    gap: 2px;
    padding: 10px;
    background: rgba(0, 0, 0, 0.2);
    border-radius: 8px;
    margin: 15px 0;
}

.heat-cell {
    aspect-ratio: 1;
    background: rgba(255, 255, 255, 0.1);
    border-radius: 2px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.7rem;
    transition: all 0.3s;
}

.controls {
    display: flex;
    gap: 10px;
    margin-bottom: 20px;
    flex-wrap: wrap;
}

.control-btn {
    background: rgba(255, 255, 255, 0.1);
    border: 1px solid rgba(255, 255, 255, 0.2);
    color: white;
    padding: 8px 16px;
    border-radius: 6px;
    cursor: pointer;
    font-size: 0.85rem;
    transition: all 0.3s;
    backdrop-filter: blur(5px);
}

.control-btn:hover {
    background: rgba(255, 255, 255, 0.2);
    transform: translateY(-1px);
}

.control-btn.active {
    background: var(--primary);
    border-color: var(--primary);
}

.metrics-row {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
    gap: 10px;
    margin: 15px 0;
}

.metric-item {
    text-align: center;
    padding: 10px;
    background: rgba(255, 255, 255, 0.05);
    border-radius: 8px;
}

.metric-value {
    font-size: 1.4rem;
    font-weight: 700;
    color: var(--accent);
}

.metric-label {
    font-size: 0.8rem;
    opacity: 0.8;
    margin-top: 4px;
}

.progress-ring {
    width: 80px;
    height: 80px;
    margin: 10px auto;
}

.progress-ring circle {
    fill: transparent;
    stroke-width: 4;
    stroke-dasharray: 251.2;
    stroke-dashoffset: 251.2;
    transform: rotate(-90deg);
    transform-origin: 50% 50%;
    transition: stroke-dashoffset 0.5s ease;
}

.progress-ring .bg {
    stroke: rgba(255, 255, 255, 0.1);
}

.progress-ring .progress {
    stroke: var(--accent);
}

.alert-panel {
    background: rgba(239, 68, 68, 0.1);
    border: 1px solid rgba(239, 68, 68, 0.3);
    border-radius: 8px;
    padding: 15px;
    margin: 15px 0;
    display: none;
}

.alert-panel.show {
    display: block;
    animation: slideIn 0.3s ease;
}

@keyframes slideIn {
    from { opacity: 0; transform: translateY(-10px); }
    to { opacity: 1; transform: translateY(0); }
}

@keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.5; }
}

.floating-stats {
    position: fixed;
    bottom: 20px;
    right: 20px;
    background: rgba(0, 0, 0, 0.8);
    backdrop-filter: blur(10px);
    padding: 15px;
    border-radius: 10px;
    border: 1px solid rgba(255, 255, 255, 0.2);
    min-width: 200px;
}

.no-data {
    text-align: center;
    color: var(--gray);
    font-style: italic;
    padding: 40px 20px;
}

@media (max-width: 1024px) {
    .dashboard {
        grid-template-areas: 
            "header"
            "main";
        grid-template-columns: 1fr;
    }
    
    .sidebar {
        display: none;
    }
    
    .main-content {
        grid-template-columns: 1fr;
        padding: 20px;
    }
}

::-webkit-scrollbar {
    width: 6px;
}

::-webkit-scrollbar-track {
    background: rgba(255, 255, 255, 0.05);
    border-radius: 3px;
}

::-webkit-scrollbar-thumb {
    background: rgba(255, 255, 255, 0.3);
    border-radius: 3px;
}

::-webkit-scrollbar-thumb:hover {
    background: rgba(255, 255, 255, 0.5);
}
    </style>
</head>
<body>
    <div class="dashboard">
        <!-- å¤´éƒ¨ -->
        <div class="header">
            <h1>ğŸ“Š æ•™è‚²æ•°æ®æ§åˆ¶å°</h1>
            <div class="connection-status">
                <span class="status-dot" id="connectionStatus"></span>
                <span id="connectionText">ç­‰å¾…è¿æ¥...</span>
            </div>
        </div>

        <!-- ä¾§è¾¹æ ç»Ÿè®¡ -->
        <div class="sidebar">
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-value" id="sessionDuration">00:00</div>
                    <div class="stat-label">ä¼šè¯æ—¶é•¿</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="totalEvents">0</div>
                    <div class="stat-label">æ€»äº‹ä»¶æ•°</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="eventsPerMinute">0</div>
                    <div class="stat-label">äº‹ä»¶/åˆ†é’Ÿ</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="dataTransferred">0KB</div>
                    <div class="stat-label">æ•°æ®ä¼ è¾“</div>
                </div>
            </div>

            <div class="controls">
                <button class="control-btn active" onclick="toggleAutoScroll()">è‡ªåŠ¨æ»šåŠ¨</button>
                <button class="control-btn" onclick="exportCurrentData()">å¯¼å‡ºæ•°æ®</button>
                <button class="control-btn" onclick="clearDisplay()">æ¸…ç©ºæ˜¾ç¤º</button>
            </div>

            <div class="alert-panel" id="alertPanel">
                <strong>âš ï¸ æ³¨æ„</strong>
                <div id="alertMessage">æ£€æµ‹åˆ°å¼‚å¸¸æ•°æ®æ¨¡å¼</div>
            </div>
        </div>

        <!-- ä¸»å†…å®¹åŒºåŸŸ -->
        <div class="main-content">
            <!-- å®æ—¶äº‹ä»¶æµ -->
            <div class="data-panel">
                <div class="panel-header">
                    <div class="panel-title">
                        <span>âš¡</span> å®æ—¶äº‹ä»¶æµ
                    </div>
                    <div class="panel-badge" id="eventCount">0</div>
                </div>
                <div class="event-stream" id="eventStream">
                    <div class="no-data">ç­‰å¾…æ•°æ®é‡‡é›†...</div>
                </div>
            </div>

            <!-- è¡Œä¸ºåˆ†æ -->
            <div class="data-panel">
                <div class="panel-header">
                    <div class="panel-title">
                        <span>ğŸ¯</span> è¡Œä¸ºåˆ†æ
                    </div>
                    <div class="panel-badge" id="behaviorCount">0</div>
                </div>
                <div class="chart-container" id="behaviorChart">
                    <div class="activity-chart" id="activityBars"></div>
                </div>
                <div class="metrics-row">
                    <div class="metric-item">
                        <div class="metric-value" id="clickCount">0</div>
                        <div class="metric-label">ç‚¹å‡»æ¬¡æ•°</div>
                    </div>
                    <div class="metric-item">
                        <div class="metric-value" id="scrollCount">0</div>
                        <div class="metric-label">æ»šåŠ¨æ¬¡æ•°</div>
                    </div>
                    <div class="metric-item">
                        <div class="metric-value" id="keyCount">0</div>
                        <div class="metric-label">æŒ‰é”®æ¬¡æ•°</div>
                    </div>
                </div>
            </div>

            <!-- æµ‹éªŒæ•°æ® -->
            <div class="data-panel">
                <div class="panel-header">
                    <div class="panel-title">
                        <span>ğŸ“</span> æµ‹éªŒæ•°æ®
                    </div>
                    <div class="panel-badge" id="quizCount">0</div>
                </div>
                <div class="data-display" id="quizDisplay">
                    æš‚æ— æµ‹éªŒæ•°æ®
                </div>
            </div>

            <!-- ä¸“æ³¨åº¦ç›‘æµ‹ -->
            <div class="data-panel">
                <div class="panel-header">
                    <div class="panel-title">
                        <span>ğŸ§˜</span> ä¸“æ³¨åº¦ç›‘æµ‹
                    </div>
                    <div class="panel-badge" id="focusScore">0%</div>
                </div>
                <div style="text-align: center;">
                    <svg class="progress-ring" viewBox="0 0 100 100">
                        <circle class="bg" cx="50" cy="50" r="40"></circle>
                        <circle class="progress" cx="50" cy="50" r="40" id="focusRing"></circle>
                    </svg>
                </div>
                <div class="data-display" id="focusDisplay">
                    æš‚æ— ä¸“æ³¨åº¦æ•°æ®
                </div>
            </div>

            <!-- å†™ä½œåˆ†æ -->
            <div class="data-panel">
                <div class="panel-header">
                    <div class="panel-title">
                        <span>âœï¸</span> å†™ä½œåˆ†æ
                    </div>
                    <div class="panel-badge" id="writingProgress">0%</div>
                </div>
                <div class="metrics-row">
                    <div class="metric-item">
                        <div class="metric-value" id="wordCount">0</div>
                        <div class="metric-label">å­—æ•°</div>
                    </div>
                    <div class="metric-item">
                        <div class="metric-value" id="writingSpeed">0</div>
                        <div class="metric-label">å­—/åˆ†é’Ÿ</div>
                    </div>
                </div>
                <div class="data-display" id="writingDisplay">
                    æš‚æ— å†™ä½œæ•°æ®
                </div>
            </div>

            <!-- äº¤äº’çƒ­åŠ›å›¾ -->
            <div class="data-panel">
                <div class="panel-header">
                    <div class="panel-title">
                        <span>ğŸ”¥</span> äº¤äº’çƒ­åŠ›å›¾
                    </div>
                    <div class="panel-badge" id="interactionCount">0</div>
                </div>
                <div class="heatmap-visual" id="heatmapDisplay">
                    <!-- å°†ç”±JavaScriptç”Ÿæˆ -->
                </div>
                <div class="data-display" id="heatmapData">
                    æš‚æ— äº¤äº’æ•°æ®
                </div>
            </div>
        </div>
    </div>

    <!-- æµ®åŠ¨ç»Ÿè®¡ -->
    <div class="floating-stats">
        <div style="font-weight: 600; margin-bottom: 8px;">å®æ—¶ç»Ÿè®¡</div>
        <div>æ›´æ–°é¢‘ç‡: <span id="updateRate">0/ç§’</span></div>
        <div>æ•°æ®å»¶è¿Ÿ: <span id="dataLatency">0ms</span></div>
    </div>

    <script>
// å…¨å±€å˜é‡
let currentData = null;
let autoScroll = true;
let updateCount = 0;
let lastUpdateTime = Date.now();
let dataBuffer = [];

// é¡µé¢åŠ è½½åˆå§‹åŒ–
window.onload = function() {
    initializeDashboard();
    requestDataFromCollector();
    
    // åˆå§‹åŒ–çƒ­åŠ›å›¾ç½‘æ ¼
    initializeHeatmap();
    
    // å®šæœŸæ›´æ–°ç»Ÿè®¡
    setInterval(updateStats, 1000);
    setInterval(updateRate, 1000);
};

// åˆå§‹åŒ–ä»ªè¡¨æ¿
function initializeDashboard() {
    console.log('æ•°æ®æ˜¾ç¤ºæ§åˆ¶å°å·²å¯åŠ¨');
    
    // ç›‘å¬æ¥è‡ªé‡‡é›†é¡µé¢çš„æ¶ˆæ¯
    window.addEventListener('message', handleDataMessage);
    
    // æ£€æŸ¥localStorageä¸­çš„æ•°æ®
    checkStoredData();
}

// å¤„ç†æ¥è‡ªé‡‡é›†é¡µé¢çš„æ¶ˆæ¯
function handleDataMessage(event) {
    if (event.data.type === 'dataUpdate') {
        updateConnectionStatus(true);
        processIncomingData(event.data.data);
    } else if (event.data.type === 'collectorClosed') {
        updateConnectionStatus(false);
    }
}

// è¯·æ±‚é‡‡é›†é¡µé¢æ•°æ®
function requestDataFromCollector() {
    if (window.opener && !window.opener.closed) {
        window.opener.postMessage({
            type: 'requestData'
        }, '*');
    }
}

// æ£€æŸ¥æœ¬åœ°å­˜å‚¨çš„æ•°æ®
function checkStoredData() {
    const storedData = localStorage.getItem('educationData');
    if (storedData) {
        try {
            const data = JSON.parse(storedData);
            processIncomingData(data);
            updateConnectionStatus(true);
        } catch (error) {
            console.warn('è§£æå­˜å‚¨æ•°æ®å¤±è´¥:', error);
        }
    }
    
    // å®šæœŸæ£€æŸ¥æ›´æ–°
    setInterval(checkStoredData, 2000);
}

// æ›´æ–°è¿æ¥çŠ¶æ€
function updateConnectionStatus(connected) {
    const statusDot = document.getElementById('connectionStatus');
    const statusText = document.getElementById('connectionText');
    
    if (connected) {
        statusDot.classList.add('connected');
        statusText.textContent = 'å®æ—¶è¿æ¥';
    } else {
        statusDot.classList.remove('connected');
        statusText.textContent = 'è¿æ¥æ–­å¼€';
    }
}

// å¤„ç†æ¥æ”¶åˆ°çš„æ•°æ®
function processIncomingData(data) {
    currentData = data;
    updateCount++;
    
    // æ›´æ–°å„ä¸ªé¢æ¿
    updateEventStream(data);
    updateBehaviorAnalysis(data);
    updateQuizData(data);
    updateFocusData(data);
    updateWritingData(data);
    updateInteractionHeatmap(data);
    updateSidebarStats(data);
}

// æ›´æ–°äº‹ä»¶æµ
function updateEventStream(data) {
    const eventStream = document.getElementById('eventStream');
    const eventCount = document.getElementById('eventCount');
    
    if (!data.events || data.events.length === 0) {
        eventStream.innerHTML = '<div class="no-data">æš‚æ— äº‹ä»¶æ•°æ®</div>';
        eventCount.textContent = '0';
        return;
    }
    
    eventCount.textContent = data.events.length;
    
    // æ˜¾ç¤ºæœ€è¿‘çš„20ä¸ªäº‹ä»¶
    const recentEvents = data.events.slice(-20).reverse();
    
    eventStream.innerHTML = recentEvents.map(event => `
        <div class="event-item">
            <div class="event-time">${new Date(event.timestamp).toLocaleTimeString()}</div>
            <div class="event-type">${event.type}</div>
            <div class="event-data">${formatEventData(event)}</div>
        </div>
    `).join('');
    
    if (autoScroll) {
        eventStream.scrollTop = 0;
    }
}

// æ ¼å¼åŒ–äº‹ä»¶æ•°æ®
function formatEventData(event) {
    switch (event.type) {
        case 'click':
            return `${event.element} (${event.x}, ${event.y})`;
        case 'scroll':
            return `Y: ${event.scrollY}px`;
        case 'quiz_selection':
            return `Q${event.question}: ${event.answer}`;
        case 'writing_progress':
            return `${event.wordCount} å­— (${event.progress.toFixed(1)}%)`;
        case 'grid_click':
            return `Cell ${event.cellIndex} (${event.clicks} clicks)`;
        case 'focus_training_start':
            return 'ä¸“æ³¨è®­ç»ƒå¼€å§‹';
        case 'session_start':
            return 'ä¼šè¯å¼€å§‹';
        default:
            return JSON.stringify(event).substring(0, 50) + '...';
    }
}

// æ›´æ–°è¡Œä¸ºåˆ†æ
function updateBehaviorAnalysis(data) {
    if (!data.events) return;
    
    const events = data.events;
    const clickCount = events.filter(e => e.type === 'click').length;
    const scrollCount = events.filter(e => e.type === 'scroll').length;
    const keyCount = events.filter(e => e.type === 'keypress').length;
    
    document.getElementById('clickCount').textContent = clickCount;
    document.getElementById('scrollCount').textContent = scrollCount;
    document.getElementById('keyCount').textContent = keyCount;
    document.getElementById('behaviorCount').textContent = clickCount + scrollCount + keyCount;
    
    // æ›´æ–°æ´»åŠ¨å›¾è¡¨
    updateActivityChart(events);
}

// æ›´æ–°æ´»åŠ¨å›¾è¡¨
function updateActivityChart(events) {
    const activityBars = document.getElementById('activityBars');
    
    // æŒ‰åˆ†é’Ÿåˆ†ç»„äº‹ä»¶
    const now = Date.now();
    const minuteGroups = {};
    
    for (let i = 0; i < 20; i++) {
        const minute = now - (i * 60000);
        minuteGroups[minute] = 0;
    }
    
    events.forEach(event => {
        const eventMinute = Math.floor(event.timestamp / 60000) * 60000;
        if (minuteGroups.hasOwnProperty(eventMinute)) {
            minuteGroups[eventMinute]++;
        }
    });
    
    const maxCount = Math.max(...Object.values(minuteGroups), 1);
    
    activityBars.innerHTML = Object.values(minuteGroups)
        .reverse()
        .map(count => `
            <div class="activity-bar" style="height: ${(count / maxCount) * 100}%" title="${count} events"></div>
        `).join('');
}

// æ›´æ–°æµ‹éªŒæ•°æ®
function updateQuizData(data) {
    const quizDisplay = document.getElementById('quizDisplay');
    const quizCount = document.getElementById('quizCount');
    
    if (!data.quizData || data.quizData.length === 0) {
        quizDisplay.textContent = 'æš‚æ— æµ‹éªŒæ•°æ®';
        quizCount.textContent = '0';
        return;
    }
    
    quizCount.textContent = data.quizData.length;
    
    const quizText = data.quizData.map(quiz => {
        if (quiz.question && quiz.answer) {
            return `é—®é¢˜ ${quiz.question}: ${quiz.answer} (${(quiz.timeFromStart / 1000).toFixed(1)}s)`;
        }
        return JSON.stringify(quiz);
    }).join('\n');
    
    quizDisplay.textContent = quizText;
}

// æ›´æ–°ä¸“æ³¨åº¦æ•°æ®
function updateFocusData(data) {
    const focusDisplay = document.getElementById('focusDisplay');
    const focusScore = document.getElementById('focusScore');
    const focusRing = document.getElementById('focusRing');
    
    if (!data.focusData || data.focusData.length === 0) {
        focusDisplay.textContent = 'æš‚æ— ä¸“æ³¨åº¦æ•°æ®';
        focusScore.textContent = '0%';
        focusRing.style.strokeDashoffset = '251.2';
        return;
    }
    
    const latestFocus = data.focusData[data.focusData.length - 1];
    const progress = latestFocus.progress || 0;
    
    focusScore.textContent = `${Math.round(progress)}%`;
    
    // æ›´æ–°ç¯å½¢è¿›åº¦æ¡
    const offset = 251.2 - (251.2 * progress / 100);
    focusRing.style.strokeDashoffset = offset;
    
    // æ˜¾ç¤ºä¸“æ³¨åº¦å†å²
    const focusText = data.focusData.slice(-5).map(focus => {
        return `${new Date(focus.timestamp).toLocaleTimeString()}: ${(focus.progress || 0).toFixed(1)}%`;
    }).join('\n');
    
    focusDisplay.textContent = focusText;
}

// æ›´æ–°å†™ä½œæ•°æ®
function updateWritingData(data) {
    const writingDisplay = document.getElementById('writingDisplay');
    const writingProgress = document.getElementById('writingProgress');
    const wordCount = document.getElementById('wordCount');
    const writingSpeed = document.getElementById('writingSpeed');
    
    if (!data.writingData || data.writingData.length === 0) {
        writingDisplay.textContent = 'æš‚æ— å†™ä½œæ•°æ®';
        writingProgress.textContent = '0%';
        wordCount.textContent = '0';
        writingSpeed.textContent = '0';
        return;
    }
    
    const latestWriting = data.writingData[data.writingData.length - 1];
    
    writingProgress.textContent = `${Math.round(latestWriting.progress || 0)}%`;
    wordCount.textContent = latestWriting.wordCount || 0;
    
    // è®¡ç®—å†™ä½œé€Ÿåº¦
    if (data.writingData.length > 1) {
        const firstEntry = data.writingData[0];
        const timeElapsed = (latestWriting.timestamp - firstEntry.timestamp) / 60000; // åˆ†é’Ÿ
        const speed = timeElapsed > 0 ? Math.round(latestWriting.wordCount / timeElapsed) : 0;
        writingSpeed.textContent = speed;
    }
    
    const writingText = data.writingData.slice(-5).map(writing => {
        return `${new Date(writing.timestamp).toLocaleTimeString()}: ${writing.wordCount} å­— (${writing.progress.toFixed(1)}%)`;
    }).join('\n');
    
    writingDisplay.textContent = writingText;
}

// åˆå§‹åŒ–çƒ­åŠ›å›¾
function initializeHeatmap() {
    const heatmapDisplay = document.getElementById('heatmapDisplay');
    heatmapDisplay.innerHTML = '';
    
    for (let i = 0; i < 48; i++) {
        const cell = document.createElement('div');
        cell.className = 'heat-cell';
        cell.dataset.index = i;
        heatmapDisplay.appendChild(cell);
    }
}

// æ›´æ–°äº¤äº’çƒ­åŠ›å›¾
function updateInteractionHeatmap(data) {
    const heatmapData = document.getElementById('heatmapData');
    const interactionCount = document.getElementById('interactionCount');
    
    if (!data.interactionData || data.interactionData.length === 0) {
        heatmapData.textContent = 'æš‚æ— äº¤äº’æ•°æ®';
        interactionCount.textContent = '0';
        // é‡ç½®æ‰€æœ‰å•å…ƒæ ¼
        document.querySelectorAll('.heat-cell').forEach(cell => {
            cell.style.backgroundColor = '';
            cell.textContent = '';
        });
        return;
    }
    
    const totalClicks = data.interactionData.reduce((sum, d) => sum + d.clicks, 0);
    interactionCount.textContent = totalClicks;
    
    // æ‰¾å‡ºæœ€å¤§ç‚¹å‡»æ•°ç”¨äºå½’ä¸€åŒ–
    const maxClicks = Math.max(...data.interactionData.map(d => d.clicks));
    
    // é‡ç½®æ‰€æœ‰å•å…ƒæ ¼
    document.querySelectorAll('.heat-cell').forEach(cell => {
        cell.style.backgroundColor = '';
        cell.textContent = '';
    });
    
    // æ›´æ–°æœ‰æ•°æ®çš„å•å…ƒæ ¼
    data.interactionData.forEach(item => {
        const cell = document.querySelector(`[data-index="${item.cellIndex}"]`);
        if (cell) {
            const intensity = item.clicks / maxClicks;
            cell.style.backgroundColor = `rgba(76, 201, 240, ${intensity})`;
            cell.style.color = intensity > 0.5 ? 'white' : 'black';
            cell.textContent = item.clicks;
        }
    });
    
    // æ˜¾ç¤ºçƒ­åŠ›å›¾ç»Ÿè®¡
    const heatmapText = `æ€»ç‚¹å‡»: ${totalClicks}\næ´»è·ƒåŒºåŸŸ: ${data.interactionData.length}\næœ€é«˜ç‚¹å‡»: ${maxClicks}`;
    heatmapData.textContent = heatmapText;
}

// æ›´æ–°ä¾§è¾¹æ ç»Ÿè®¡
function updateSidebarStats(data) {
    // ä¼šè¯æ—¶é•¿
    if (data.startTime) {
        const duration = Date.now() - data.startTime;
        const minutes = Math.floor(duration / 60000);
        const seconds = Math.floor((duration % 60000) / 1000);
        document.getElementById('sessionDuration').textContent = 
            `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
    }
    
    // æ€»äº‹ä»¶æ•°
    document.getElementById('totalEvents').textContent = data.events ? data.events.length : 0;
    
    // äº‹ä»¶/åˆ†é’Ÿ
    if (data.startTime && data.events) {
        const durationMinutes = (Date.now() - data.startTime) / 60000;
        const eventsPerMinute = durationMinutes > 0 ? Math.round(data.events.length / durationMinutes) : 0;
        document.getElementById('eventsPerMinute').textContent = eventsPerMinute;
    }
    
    // æ•°æ®å¤§å°
    const dataSize = JSON.stringify(data).length;
    document.getElementById('dataTransferred').textContent = 
        dataSize > 1024 ? `${(dataSize / 1024).toFixed(1)}KB` : `${dataSize}B`;
}

// æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
function updateStats() {
    // æ›´æ–°æµ®åŠ¨ç»Ÿè®¡çš„å»¶è¿Ÿæ˜¾ç¤º
    const latency = Date.now() - lastUpdateTime;
    document.getElementById('dataLatency').textContent = latency + 'ms';
}

// æ›´æ–°é€Ÿç‡ç»Ÿè®¡
function updateRate() {
    document.getElementById('updateRate').textContent = updateCount + '/ç§’';
    updateCount = 0;
}

// åˆ‡æ¢è‡ªåŠ¨æ»šåŠ¨
function toggleAutoScroll() {
    autoScroll = !autoScroll;
    const btn = event.target;
    btn.textContent = autoScroll ? 'è‡ªåŠ¨æ»šåŠ¨' : 'æ‰‹åŠ¨æ»šåŠ¨';
    btn.classList.toggle('active', autoScroll);
}

// å¯¼å‡ºå½“å‰æ•°æ®
function exportCurrentData() {
    if (!currentData) {
        alert('æš‚æ— æ•°æ®å¯å¯¼å‡º');
        return;
    }
    
    const exportData = {
        exportTime: new Date().toISOString(),
        ...currentData
    };
    
    const blob = new Blob([JSON.stringify(exportData, null, 2)], {
        type: 'application/json'
    });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `dashboard_export_${new Date().toISOString().slice(0, 10)}.json`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
}

// æ¸…ç©ºæ˜¾ç¤º
function clearDisplay() {
    if (confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰æ˜¾ç¤ºæ•°æ®å—ï¼Ÿ')) {
        currentData = null;
        
        // æ¸…ç©ºæ‰€æœ‰æ˜¾ç¤ºåŒºåŸŸ
        document.querySelectorAll('.data-display').forEach(display => {
            display.textContent = 'æš‚æ— æ•°æ®';
        });
        
        document.querySelectorAll('.panel-badge').forEach(badge => {
            badge.textContent = '0';
        });
        
        document.querySelectorAll('.metric-value').forEach(metric => {
            metric.textContent = '0';
        });
        
        document.getElementById('eventStream').innerHTML = '<div class="no-data">æš‚æ— äº‹ä»¶æ•°æ®</div>';
        document.getElementById('activityBars').innerHTML = '';
        document.getElementById('focusRing').style.strokeDashoffset = '251.2';
        
        initializeHeatmap();
        
        console.log('æ˜¾ç¤ºå·²æ¸…ç©º');
    }
}

// æ˜¾ç¤ºè­¦å‘Š
function showAlert(message) {
    const alertPanel = document.getElementById('alertPanel');
    const alertMessage = document.getElementById('alertMessage');
    
    alertMessage.textContent = message;
    alertPanel.classList.add('show');
    
    setTimeout(() => {
        alertPanel.classList.remove('show');
    }, 5000);
}

// é¡µé¢å…³é—­æ—¶æ¸…ç†
window.addEventListener('beforeunload', function() {
    if (window.opener && !window.opener.closed) {
        window.opener.postMessage({
            type: 'displayClosed'
        }, '*');
    }
});
    </script>
</body>
</html>